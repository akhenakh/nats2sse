<!doctype html>
<html>
    <head>
        <title>NATS to SSE Demo</title>
    </head>
    <body>
        <h1>SSE Messages:</h1>
        <ul id="messages"></ul>

        <script>
            // Construct the URL, ensuring parameters are URL-encoded
            const params = new URLSearchParams();
            params.append("subject", subject);

            const eventSourceUrl = `/events?${params.toString()}`;
            console.log("Connecting to:", eventSourceUrl);
            const eventSource = new EventSource(eventSourceUrl);

            eventSource.onopen = function () {
                console.log("SSE Connection opened.");
                const li = document.createElement("li");
                li.textContent = "SSE Connection opened.";
                document.getElementById("messages").appendChild(li);
            };

            // Generic message handler (if specific event names are not used often from NATS subjects)
            // eventSource.onmessage = function(event) {
            //     const li = document.createElement("li");
            //     // Data is base64 encoded by the server
            //     const decodedData = atob(event.data);
            //     li.textContent = `Event: ${event.type}, ID: ${event.id || 'N/A'}, Data: ${decodedData}`;
            //     document.getElementById("messages").appendChild(li);
            //     console.log("Generic message:", event);
            // };

            // Listen for specific events (NATS subjects)
            // Replace "foo.bar" with the actual subject you are subscribing to
            eventSource.addEventListener(subject, function (event) {
                const li = document.createElement("li");
                // Data is base64 encoded by the server
                try {
                    const decodedData = atob(event.data); // Assuming data was base64 encoded
                    li.textContent = `Event Type (Subject): ${event.type}, ID: ${event.id || "N/A"}, Data: ${decodedData}`;
                    console.log(
                        "Specific event:",
                        event.type,
                        "Data:",
                        decodedData,
                    );
                } catch (e) {
                    li.textContent = `Event Type (Subject): ${event.type}, ID: ${event.id || "N/A"}, Raw Data: ${event.data} (Error decoding: ${e})`;
                    console.error(
                        "Error decoding base64 data:",
                        e,
                        "Raw data:",
                        event.data,
                    );
                }
                document.getElementById("messages").appendChild(li);
            });

            eventSource.onerror = function (err) {
                console.error("EventSource failed:", err);
                const li = document.createElement("li");
                li.textContent = "SSE Connection error. See console.";
                li.style.color = "red";
                document.getElementById("messages").appendChild(li);
                eventSource.close(); // Close on error to prevent constant retries from browser if server is down
            };

            // Optional: Handle comments (keep-alives)
            eventSource.addEventListener("comment", function (event) {
                console.log("Received comment:", event.data);
            });
        </script>
    </body>
</html>
